<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „í™”ë²ˆí˜¸ ìˆ˜ì§‘ ê´€ë¦¬ì</title>
    <link rel="stylesheet" href="styles/admin.css">
</head>
<body>
    <div class="container">
        <!-- ì¢Œì¸¡: ë°ì´í„° í…Œì´ë¸” -->
        <div class="data-section">
            <h1>ìˆ˜ì§‘ëœ ì „í™”ë²ˆí˜¸ <span id="realTimeIndicator" class="real-time-indicator" title="ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”"></span></h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalCount">0</span>
                    <span class="stat-label">ì´ ìˆ˜ì§‘</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="todayCount">0</span>
                    <span class="stat-label">ì˜¤ëŠ˜ ìˆ˜ì§‘</span>
                </div>
            </div>
            
            <div class="actions">
                <button id="exportBtn" class="btn btn-primary" title="í´ë¦­: Excel CSV ë‚´ë³´ë‚´ê¸° | Shift+í´ë¦­: ë‹¤ë¥¸ í˜•ì‹ ì„ íƒ">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                <button id="clearBtn" class="btn btn-danger">ë°ì´í„° ì´ˆê¸°í™”</button>
                <button id="refreshBtn" class="btn btn-secondary" onclick="refreshAdminData()">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
                <button id="debugBtn" class="btn btn-secondary" onclick="showDebugInfo()">ë””ë²„ê·¸ ì •ë³´</button>
            </div>
            
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>ë²ˆí˜¸</th>
                            <th>ì´ë¦„</th>
                            <th>ì „í™”ë²ˆí˜¸</th>
                            <th>ìˆ˜ì§‘ì‹œê°„</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ìš°ì¸¡: QRì½”ë“œ -->
        <div class="qr-section">
            <h2>QRì½”ë“œ ìŠ¤ìº”</h2>
            <div class="qr-container">
                <div id="qrDisplay" style="text-align: center; padding: 20px;">
                    <!-- QRì½”ë“œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    <img id="qrImage" src="" alt="QR Code" style="max-width: 200px; height: auto; display: block;">
                    
                    <!-- ë¡œë”© í‘œì‹œ -->
                    <div id="qrLoading" style="display: none; padding: 20px;">
                        <div style="font-size: 18px; color: #3b82f6; margin-bottom: 10px;">ğŸ”„</div>
                        <p style="color: #666;">QRì½”ë“œ ìƒì„± ì¤‘...</p>
                    </div>
                    
                    <!-- ëŒ€ì²´ ë°©ë²• -->
                    <div id="qrFallback" style="border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; background: #f8fafc; display: none;">
                        <div style="margin-bottom: 15px;">
                            <h3 style="color: #3b82f6; margin-bottom: 10px; font-size: 18px;">ğŸ“± ëª¨ë°”ì¼ ì•± ì ‘ì†</h3>
                            <p style="color: #666; font-size: 14px;">ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ê±°ë‚˜ URLì„ ë³µì‚¬í•˜ì„¸ìš”</p>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                            <p style="font-size: 12px; word-break: break-all; color: #1f2937; margin-bottom: 10px;" id="fallbackUrl"></p>
                            <a href="" id="directLink" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600; font-size: 14px;">
                                ğŸ”— ëª¨ë°”ì¼ ì•± ì—´ê¸°
                            </a>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="copyUrl()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ“‹ URL ë³µì‚¬
                            </button>
                            <button onclick="generateQR()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ”„ QRì½”ë“œ ìƒì„±
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="qr-info">
                <p>ìœ„ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì—¬</p>
                <p>ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
            </div>
            <div class="url-display">
                <label>ëª¨ë°”ì¼ ì•± URL:</label>
                <input type="text" id="mobileUrl" readonly>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="copyUrlBtn" class="btn btn-secondary">ë³µì‚¬</button>
                    <button id="refreshQrBtn" class="btn btn-secondary">QRì½”ë“œ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/admin.js"></script>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let mobileUrl = '';
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” - DOMContentLoadedë¡œ ë” ë¹¨ë¦¬ ì‹œì‘
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        // ë°±ì—…ìœ¼ë¡œ window.loadë„ ì‚¬ìš©
        window.addEventListener('load', function() {
            if (!mobileUrl) {
                initApp();
            }
        });
        
        // ì•± ì´ˆê¸°í™”
        function initApp() {
            console.log('ğŸš€ ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            // URL ì„¤ì •
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port;
            const portString = port ? `:${port}` : '';
            
            mobileUrl = `${protocol}//${hostname}${portString}/mobile.html`;
            console.log('ğŸ“± ëª¨ë°”ì¼ URL ì„¤ì •:', mobileUrl);
            
            // UI ìš”ì†Œ ì—…ë°ì´íŠ¸
            updateUI();
            
            // QRì½”ë“œ ìƒì„± ì‹œë„ (ì•½ê°„ì˜ ì§€ì—° í›„)
            setTimeout(() => {
                generateQR();
            }, 100);
        }
        
        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const urlInput = document.getElementById('mobileUrl');
            const fallbackUrl = document.getElementById('fallbackUrl');
            const directLink = document.getElementById('directLink');
            
            urlInput.value = mobileUrl;
            fallbackUrl.textContent = mobileUrl;
            directLink.href = mobileUrl;
        }
        
        // QRì½”ë“œ ìƒì„±
        function generateQR() {
            const qrImage = document.getElementById('qrImage');
            const qrFallback = document.getElementById('qrFallback');
            const qrLoading = document.getElementById('qrLoading');
            
            console.log('QRì½”ë“œ ìƒì„± ì‹œë„...');
            console.log('í˜„ì¬ URL:', mobileUrl);
            console.log('í˜„ì¬ hostname:', window.location.hostname);
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            qrImage.style.display = 'none';
            qrFallback.style.display = 'none';
            qrLoading.style.display = 'block';
            
            // ë‹¤ì¤‘ QR API ì‹œë„
            const qrApis = [
                `https://chart.googleapis.com/chart?chs=220x220&cht=qr&chl=${encodeURIComponent(mobileUrl)}`,
                `https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=${encodeURIComponent(mobileUrl)}`,
                `https://qr-code-styling.com/qr_code?data=${encodeURIComponent(mobileUrl)}&size=220`
            ];
            
            let currentApiIndex = 0;
            
            function tryNextQrApi() {
                if (currentApiIndex >= qrApis.length) {
                    // ëª¨ë“  API ì‹¤íŒ¨
                    console.log('âŒ ëª¨ë“  QR API ì‹¤íŒ¨');
                    qrLoading.style.display = 'none';
                    qrImage.style.display = 'none';
                    qrFallback.style.display = 'block';
                    
                    if (window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1' || 
                        window.location.protocol === 'file:') {
                        showLocalInfo();
                    } else {
                        showGeneralFallback();
                    }
                    return;
                }
                
                const currentUrl = qrApis[currentApiIndex];
                console.log(`QR API ì‹œë„ ${currentApiIndex + 1}/${qrApis.length}:`, currentUrl);
                
                // íƒ€ì„ì•„ì›ƒ ì„¤ì • (2ì´ˆ)
                const timeout = setTimeout(() => {
                    console.log(`QR API ${currentApiIndex + 1} íƒ€ì„ì•„ì›ƒ`);
                    currentApiIndex++;
                    tryNextQrApi();
                }, 2000);
                
                qrImage.onload = function() {
                    clearTimeout(timeout);
                    console.log('âœ… QRì½”ë“œ ìƒì„± ì„±ê³µ!');
                    qrLoading.style.display = 'none';
                    qrImage.style.display = 'block';
                    qrFallback.style.display = 'none';
                };
                
                qrImage.onerror = function() {
                    clearTimeout(timeout);
                    console.log(`âŒ QR API ${currentApiIndex + 1} ì‹¤íŒ¨`);
                    currentApiIndex++;
                    tryNextQrApi();
                };
                
                qrImage.src = currentUrl;
            }
            
            // ì²« ë²ˆì§¸ API ì‹œë„
            tryNextQrApi();
        }
        
        // ë¡œì»¬ í™˜ê²½ ì •ë³´ í‘œì‹œ
        function showLocalInfo() {
            const qrImage = document.getElementById('qrImage');
            const qrFallback = document.getElementById('qrFallback');
            
            qrImage.style.display = 'none';
            qrFallback.style.display = 'block';
            
            // ë¡œì»¬ í™˜ê²½ìš© ì•ˆë‚´ ì—…ë°ì´íŠ¸
            const fallbackDiv = document.getElementById('qrFallback');
            fallbackDiv.innerHTML = `
                <div style="border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; background: #fffbeb;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: #f59e0b; margin-bottom: 10px; font-size: 18px;">ğŸ  ë¡œì»¬ í™˜ê²½ì—ì„œ ì‹¤í–‰ ì¤‘</h3>
                        <p style="color: #666; font-size: 14px;">QRì½”ë“œëŠ” ì›¹ì„œë²„ì— ë°°í¬ í›„ ìƒì„±ë©ë‹ˆë‹¤</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #fbbf24;">
                        <p style="font-size: 14px; margin-bottom: 10px; font-weight: 600;">í…ŒìŠ¤íŠ¸ ë°©ë²•:</p>
                        <p style="font-size: 12px; word-break: break-all; color: #1f2937; margin-bottom: 10px;">${mobileUrl}</p>
                        <p style="font-size: 12px; color: #666;">
                            ğŸ“± ê°™ì€ ë„¤íŠ¸ì›Œí¬ì˜ ìŠ¤ë§ˆíŠ¸í°ì—ì„œ ìœ„ URLë¡œ ì ‘ì†í•˜ì„¸ìš”<br>
                            (ì»´í“¨í„°ì™€ ìŠ¤ë§ˆíŠ¸í°ì´ ê°™ì€ WiFiì— ì—°ê²°ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)
                        </p>
                    </div>
                    
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0ea5e9;">
                        <p style="font-size: 14px; margin-bottom: 8px; font-weight: 600; color: #0369a1;">ğŸ’¡ ë°°í¬ í›„ QRì½”ë“œ ìƒì„±ë©ë‹ˆë‹¤:</p>
                        <p style="font-size: 12px; color: #0369a1;">
                            â€¢ GitHub Pages<br>
                            â€¢ Netlify<br>
                            â€¢ Vercel<br>
                            â€¢ ì›¹ í˜¸ìŠ¤íŒ… ì„œë¹„ìŠ¤
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="copyUrl()" style="padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸ“‹ URL ë³µì‚¬
                        </button>
                        <button onclick="showNetworkIP()" style="padding: 10px 20px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸŒ ë„¤íŠ¸ì›Œí¬ IP í™•ì¸
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ì¼ë°˜ì ì¸ ëŒ€ì²´ ë°©ë²• í‘œì‹œ
        function showGeneralFallback() {
            const fallbackDiv = document.getElementById('qrFallback');
            fallbackDiv.innerHTML = `
                <div style="border: 2px solid #ef4444; border-radius: 12px; padding: 20px; background: #fef2f2;">
                    <div style="margin-bottom: 15px;">
                        <h3 style="color: #ef4444; margin-bottom: 10px; font-size: 18px;">âš ï¸ QRì½”ë“œ ìƒì„± ì‹¤íŒ¨</h3>
                        <p style="color: #666; font-size: 14px;">ë„¤íŠ¸ì›Œí¬ ë¬¸ì œë¡œ QRì½”ë“œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e5e7eb;">
                        <p style="font-size: 12px; word-break: break-all; color: #1f2937; margin-bottom: 10px;">${mobileUrl}</p>
                        <a href="${mobileUrl}" target="_blank" style="color: #3b82f6; text-decoration: none; font-weight: 600; font-size: 14px;">
                            ğŸ”— ëª¨ë°”ì¼ ì•± ì—´ê¸°
                        </a>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="copyUrl()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸ“‹ URL ë³µì‚¬
                        </button>
                        <button onclick="generateQR()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ë„¤íŠ¸ì›Œí¬ IP ì •ë³´ í‘œì‹œ
        function showNetworkIP() {
            const networkInfo = `
í˜„ì¬ localhostë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.

ìŠ¤ë§ˆíŠ¸í°ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ë ¤ë©´:
1. ì»´í“¨í„°ì˜ IP ì£¼ì†Œë¥¼ í™•ì¸í•˜ì„¸ìš”
2. localhostë¥¼ í•´ë‹¹ IPë¡œ ë°”ê¿”ì„œ ì ‘ì†í•˜ì„¸ìš”

ì˜ˆì‹œ:
- í˜„ì¬: ${mobileUrl}
- ë³€ê²½: http://192.168.1.100:í¬íŠ¸ë²ˆí˜¸/mobile.html

IP í™•ì¸ ë°©ë²•:
â€¢ Windows: cmdì—ì„œ 'ipconfig' ì‹¤í–‰
â€¢ Mac/Linux: í„°ë¯¸ë„ì—ì„œ 'ifconfig' ì‹¤í–‰
â€¢ ë˜ëŠ” ì‹œìŠ¤í…œ ì„¤ì •ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸
            `;
            
            alert(networkInfo);
        }
        
        // URL ë³µì‚¬
        function copyUrl() {
            const urlInput = document.getElementById('mobileUrl');
            
            // í´ë¦½ë³´ë“œ API ì‚¬ìš©
            if (navigator.clipboard) {
                navigator.clipboard.writeText(mobileUrl).then(() => {
                    showMessage('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹');
                }).catch(() => {
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }
        
        // ëŒ€ì²´ ë³µì‚¬ ë°©ë²•
        function fallbackCopy() {
            const urlInput = document.getElementById('mobileUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                showMessage('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“‹');
            } catch (err) {
                showMessage('URLì„ ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”: ' + mobileUrl);
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function showMessage(text) {
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            const existingMsg = document.getElementById('copyMessage');
            if (existingMsg) {
                existingMsg.remove();
            }
            
            // ìƒˆ ë©”ì‹œì§€ ìƒì„±
            const message = document.createElement('div');
            message.id = 'copyMessage';
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            message.textContent = text;
            
            document.body.appendChild(message);
            
            // 3ì´ˆ í›„ ì œê±°
            setTimeout(() => {
                if (message.parentNode) {
                    message.remove();
                }
            }, 3000);
        }
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // ë””ë²„ê·¸ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        window.showDebugInfo = async function() {
            const phoneManager = window.phoneManager;
            let debugInfo = `=== ë””ë²„ê·¸ ì •ë³´ ===\n\n`;
            
            if (phoneManager) {
                debugInfo += `ê´€ë¦¬ì ëª¨ë“œ: ${phoneManager.useSupabase ? 'Supabase' : 'localStorage'}\n`;
                debugInfo += `í˜„ì¬ ë°ì´í„° ìˆ˜: ${phoneManager.data ? phoneManager.data.length : 0}ê°œ\n\n`;
                
                if (phoneManager.useSupabase && window.supabaseManager) {
                    try {
                        const testResult = await window.supabaseManager.testConnection();
                        debugInfo += `Supabase ì—°ê²°: ${testResult.success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\n`;
                        if (!testResult.success) {
                            debugInfo += `ì—°ê²° ì˜¤ë¥˜: ${testResult.message}\n`;
                        }
                        
                        const stats = await window.supabaseManager.getStats();
                        debugInfo += `DB í†µê³„: ì´ ${stats.total}ê°œ, ì˜¤ëŠ˜ ${stats.today}ê°œ\n\n`;
                    } catch (error) {
                        debugInfo += `Supabase ì˜¤ë¥˜: ${error.message}\n\n`;
                    }
                }
                
                if (phoneManager.data && phoneManager.data.length > 0) {
                    debugInfo += `ìµœê·¼ ë°ì´í„° 3ê°œ:\n`;
                    phoneManager.data.slice(0, 3).forEach((item, index) => {
                        debugInfo += `${index + 1}. ${item.name} - ${item.phone} (${new Date(item.created_at || item.timestamp).toLocaleString('ko-KR')})\n`;
                    });
                }
            } else {
                debugInfo += `âŒ phoneManagerê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n`;
            }
            
            const storedData = JSON.parse(localStorage.getItem('phoneData')) || [];
            debugInfo += `\nlocalStorage ë°ì´í„°: ${storedData.length}ê°œ\n`;
            
            debugInfo += `\n=== í•´ê²° ë°©ë²• ===\n`;
            debugInfo += `1. "ë°ì´í„° ìƒˆë¡œê³ ì¹¨" ë²„íŠ¼ í´ë¦­\n`;
            debugInfo += `2. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (F5)\n`;
            debugInfo += `3. ì½˜ì†”ì—ì„œ refreshAdminData() ì‹¤í–‰\n`;
            debugInfo += `4. ì½˜ì†”ì—ì„œ testSupabaseDelete() ì‹¤í–‰ (ì‚­ì œ í…ŒìŠ¤íŠ¸)\n`;
            
            alert(debugInfo);
        };
        
        // ì „ì—­ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ (ë°±ì—…)
        if (typeof refreshAdminData === 'undefined') {
            window.refreshAdminData = function() {
                console.log('ì „ì—­ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜ í˜¸ì¶œ');
                location.reload();
            };
        }
        
        // ë¡œì»¬ í™˜ê²½ì—ì„œ ê¸°ì¡´ Service Worker ì •ë¦¬
        if ((window.location.hostname.includes('localhost') || window.location.hostname.includes('127.0.0.1')) && 'serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    console.log('ğŸ§¹ ê¸°ì¡´ Service Worker ì œê±°:', registration.scope);
                    registration.unregister();
                }
            }).catch(function(error) {
                console.log('Service Worker ì œê±° ì¤‘ ì˜¤ë¥˜:', error);
            });
        }
    </script>
</body>
</html>
